{% extends "base.html" %}
{% block title %}Inicio | Bunny Scheduler{% endblock %}
{% block content %}
<div class="flex flex-col md:flex-row gap-8 min-h-[60vh] justify-center items-start">
    <!-- Calendario -->
    <div class="bg-white rounded shadow p-8 w-full max-w-xl md:w-1/2">
        <h2 class="text-2xl font-bold mb-6 text-center text-purple-700">Calendario</h2>
        <div class="flex justify-between items-center mb-4">
            <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">&#8592;</button>
            <span id="calendarTitle" class="text-lg font-semibold"></span>
            <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">&#8594;</button>
        </div>
        <div class="overflow-x-auto">
            <table id="calendarTable" class="min-w-full border border-gray-200"></table>
        </div>
    </div>
    <!-- Proposals del usuario -->
    <div class="bg-white rounded shadow p-8 w-full max-w-xl md:w-1/2">
        <h2 class="text-2xl font-bold mb-6 text-center text-blue-700">Mis Propuestas Recibidas</h2>
        <div class="mb-4 flex flex-col md:flex-row md:items-center gap-2">
            <label for="proposal-status-filter" class="text-sm font-medium">Filtrar por estado:</label>
            <select id="proposal-status-filter" class="form-select border rounded px-2 py-1">
                <option value="">Todas</option>
                <option value="pending">Pendiente</option>
                <option value="accepted">Aceptada</option>
                <option value="rejected">Rechazada</option>
            </select>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-200" id="proposals-table">
                <thead>
                    <tr>
                        <th class="p-2 border">Solicitante</th>
                        <th class="p-2 border">Reserva</th>
                        <th class="p-2 border">Motivo</th>
                        <th class="p-2 border">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in user_proposals %}
                    <tr data-status="{{ p.status }}">
                        <td class="p-2 border">{{ p.proponent.username }}</td>
                        <td class="p-2 border">{{ p.reservation.start_time|date:"d/m/Y H:i" }}
                            <br>{{p.reservation.description }}
                        </td>
                        <td class="p-2 border">{{ p.motivation }}</td>
                        <td class="p-2 border">
                            {% if p.status == "pending" %}
                            <span class="text-yellow-600">Pendiente</span>
                            <div>
                                <button type="button"
                                    class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs ml-2"
                                    onclick="updateProposalStatus('{{ p.id }}', 'accepted')">Aceptar</button>
                                <button type="button"
                                    class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs ml-2"
                                    onclick="updateProposalStatus('{{ p.id }}', 'rejected')">Rechazar</button>
                            </div>
                            {% elif p.status == "accepted" %}
                            <span class="text-green-600">Aceptada</span>
                            {% elif p.status == "rejected" %}
                            <span class="text-red-600">Rechazada</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="p-2 border text-center text-gray-500">No tienes propuestas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateProposalStatus(proposalId, status) {
        fetch('{% url "proposal" %}', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ proposal_id: proposalId, status: status })
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    response.text().then(text => alert('Error: ' + text));
                }
            })
            .catch(error => alert('Error: ' + error));
    }
    // Filtro de proposals por estado
    document.getElementById('proposal-status-filter').addEventListener('change', function () {
        const value = this.value;
        document.querySelectorAll('#proposals-table tbody tr').forEach(row => {
            if (!value || row.getAttribute('data-status') === value) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    let today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();

    function renderCalendar(month, year) {
        const calendarTitle = document.getElementById("calendarTitle");
        calendarTitle.textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        // Lunes = 0, Domingo = 6 (ajustar para que lunes sea el primer día)
        let startDay = (firstDay.getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        let html = `<thead><tr>`;
        ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"].forEach(d => {
            html += `<th class='p-2 border'>${d}</th>`;
        });
        html += `</tr></thead><tbody>`;

        let day = 1;
        let nextMonthDay = 1;
        for (let i = 0; i < 6; i++) {
            html += `<tr>`;
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < startDay) {
                    html += `<td class='p-2 border text-gray-400'>${daysInPrevMonth - startDay + j + 1}</td>`;
                } else if (day > daysInMonth) {
                    html += `<td class='p-2 border text-gray-400'>${nextMonthDay++}</td>`;
                } else {
                    let highlight = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) ? 'bg-purple-100 font-bold' : '';
                    html += `<td class='p-2 border ${highlight} cursor-pointer hover:bg-purple-200' data-date='${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}'>${day++}</td>`;
                }
            }
            html += `</tr>`;
            if (day > daysInMonth && nextMonthDay > 7) break;
        }
        html += `</tbody>`;
        document.getElementById("calendarTable").innerHTML = html;
        // Añadir evento click a los días válidos
        document.querySelectorAll('#calendarTable td[data-date]').forEach(td => {
            td.addEventListener('click', function () {
                const date = this.getAttribute('data-date');
                window.location.href = `/reservation/?date=${date}`;
            });
        });
    }

    document.getElementById("prevMonth").onclick = function () {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentMonth, currentYear);
    };
    document.getElementById("nextMonth").onclick = function () {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentMonth, currentYear);
    };

    window.onload = function () {
        renderCalendar(currentMonth, currentYear);
    };
</script>
{% endblock %}