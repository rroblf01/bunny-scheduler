<h2 class="text-2xl font-bold mb-6 text-center text-blue-700">Mis Propuestas Recibidas</h2>
<div class="mb-4 flex flex-col md:flex-row md:items-center gap-2">
    <label for="proposal-status-filter" class="text-sm font-medium">Filtrar por estado:</label>
    <select id="proposal-status-filter" class="form-select border rounded px-2 py-1">
        <option value="">Todas</option>
        <option value="pending">Pendiente</option>
        <option value="accepted">Aceptada</option>
        <option value="rejected">Rechazada</option>
    </select>
</div>
<div class="overflow-x-auto max-h-80 overflow-y-auto">
    <table class="min-w-full border border-gray-200" id="proposals-table">
        <thead>
            <tr>
                <th class="p-2 border">Solicitante</th>
                <th class="p-2 border">Reserva</th>
                <th class="p-2 border">Motivo</th>
                <th class="p-2 border">Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for p in user_proposals %}
            <tr data-status="{{ p.status }}">
                <td class="p-2 border">{{ p.proponent.username }}</td>
                <td class="p-2 border">{{ p.reservation.start_time|date:"d/m/Y H:i" }}<br>{{p.reservation.description }}
                </td>
                <td class="p-2 border">{{ p.motivation }}</td>
                <td class="p-2 border">
                    {% if p.status == "pending" %}
                    <span class="text-yellow-600">Pendiente</span>
                    <div>
                        <button type="button"
                            class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs ml-2"
                            onclick="updateProposalStatus('{{ p.id }}', 'accepted')">Aceptar</button>
                        <button type="button"
                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs ml-2"
                            onclick="updateProposalStatus('{{ p.id }}', 'rejected')">Rechazar</button>
                    </div>
                    {% elif p.status == "accepted" %}
                    <span class="text-green-600">Aceptada</span>
                    {% elif p.status == "rejected" %}
                    <span class="text-red-600">Rechazada</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="p-2 border text-center text-gray-500">No tienes propuestas.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    function updateProposalStatus(proposalId, status) {
        fetch('{% url "proposal" %}', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token }}",
            },
            body: JSON.stringify({ proposal_id: proposalId, status: status })
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    response.text().then(text => alert('Error: ' + text));
                }
            })
            .catch(error => alert('Error: ' + error));
    }

    document.getElementById('proposal-status-filter').addEventListener('change', function () {
        const value = this.value;
        document.querySelectorAll('#proposals-table tbody tr').forEach(row => {
            if (!value || row.getAttribute('data-status') === value) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>